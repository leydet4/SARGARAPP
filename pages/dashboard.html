<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>All Stations — Live Dashboard</title>
  <link rel="stylesheet" href="../app.css"/>
  <style>
    /* Layout */
    .wrap { max-width: 1200px; margin: 0 auto; padding: 0 12px; }
    .grid { display: grid; gap: 16px; }
    @media (min-width: 720px){ .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1120px){ .grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }

    /* Card visual + spacing tuned for readability */
    .station { background:#2a2a2a; border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.45); border:1px solid #3a3a3a; }
    .station h2 { text-align:center; font-size:1.1rem; margin-bottom:10px; color:#ffcc00; letter-spacing:.2px; }

    /* Metric rows */
    .kv { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed #444; }
    .kv:last-child { border-bottom:none; }
    .kv .label { color:#cfd5e6; font-weight:700; font-size:0.95rem; }
    .kv .value { font-weight:800; font-size:1.05rem; }

    /* Tides */
    .tide-block { margin-top:10px; background:#222; border:1px solid #3a3a3a; border-radius:12px; padding:10px; }
    .tide-subtitle { text-align:center; color:#9fb8e8; font-weight:800; margin-top:2px; margin-bottom:8px; font-size:0.95rem; }
    .tide-list { list-style:none; margin:0; padding:0; }
    .tide-list li { display:flex; flex-direction:column; gap:2px; padding:8px 0; border-bottom:1px dashed #3a3a3a; }
    .tide-list li:last-child { border-bottom:none; }
    .tide-row { display:flex; justify-content:space-between; align-items:center; }
    .tide-type { font-weight:900; }
    .tide-val { font-weight:800; opacity:.95; }
    .tide-time { color:#cfd5e6; font-size:0.92rem; }

    /* Updated pill */
    .updated { text-align:center; margin-top:10px; font-size:0.9rem; color:#9fb8e8; }

    /* Buttons row */
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:12px 0 4px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="wrap">
      <h1>All Stations — Live Dashboard</h1>
      <div class="toolbar">
        <a class="btn" href="../index.html">← Back to Home</a>
        <a class="btn" id="refreshBtn" href="#">↻ Refresh</a>
      </div>
      <div class="note" style="text-align:center;margin-bottom:10px">
        Water/Wind: NOAA CO-OPS • Air: NWS KORF • Tides: NOAA predictions (MLLW)
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="notice" class="note" style="text-align:center;margin-bottom:10px;"></div>

    <div class="grid">

      <!-- Money Point -->
      <section class="station" id="money">
        <h2>Money Point (Chesapeake) (8639348)</h2>
        <div class="kv"><span class="label">Water Temp</span><span class="value" id="mo-water">—</span></div>
        <div class="kv"><span class="label">Air Temp</span><span class="value" id="mo-air">—</span></div>
        <div class="kv"><span class="label">Wind</span><span class="value" id="mo-wind">—</span></div>

        <div class="tide-block">
          <div class="tide-subtitle">Last 2 Tides</div>
          <ul class="tide-list" id="mo-last"></ul>
          <div class="tide-subtitle" style="margin-top:10px;">Next 2 Tides</div>
          <ul class="tide-list" id="mo-next"></ul>
        </div>

        <div class="updated" id="mo-updated">Updated: —</div>
      </section>
      <!-- Sewells Point -->
      <section class="station" id="sewells">
        <h2>Sewells Point (Norfolk Naval Base) (8638610)</h2>
        <div class="kv"><span class="label">Water Temp</span><span class="value" id="se-water">—</span></div>
        <div class="kv"><span class="label">Air Temp</span><span class="value" id="se-air">—</span></div>
        <div class="kv"><span class="label">Wind</span><span class="value" id="se-wind">—</span></div>

        <div class="tide-block">
          <div class="tide-subtitle">Last 2 Tides</div>
          <ul class="tide-list" id="se-last"></ul>
          <div class="tide-subtitle" style="margin-top:10px;">Next 2 Tides</div>
          <ul class="tide-list" id="se-next"></ul>
        </div>

        <div class="updated" id="se-updated">Updated: —</div>
      </section>

      <!-- Cape Henry -->
      <section class="station" id="cape">
        <h2>Cape Henry (Va Beach) (8638999)</h2>
        <div class="kv"><span class="label">Water Temp</span><span class="value" id="ca-water">—</span></div>
        <div class="kv"><span class="label">Air Temp</span><span class="value" id="ca-air">—</span></div>
        <div class="kv"><span class="label">Wind</span><span class="value" id="ca-wind">—</span></div>

        <div class="tide-block">
          <div class="tide-subtitle">Last 2 Tides</div>
          <ul class="tide-list" id="ca-last"></ul>
          <div class="tide-subtitle" style="margin-top:10px;">Next 2 Tides</div>
          <ul class="tide-list" id="ca-next"></ul>
        </div>

        <div class="updated" id="ca-updated">Updated: —</div>
      </section>

      <!-- CBBT -->
      <section class="station" id="cbbt">
        <h2>CBBT (1st Island) (8638901)</h2>
        <div class="kv"><span class="label">Water Temp</span><span class="value" id="cb-water">—</span></div>
        <div class="kv"><span class="label">Air Temp</span><span class="value" id="cb-air">—</span></div>
        <div class="kv"><span class="label">Wind</span><span class="value" id="cb-wind">—</span></div>

        <div class="tide-block">
          <div class="tide-subtitle">Last 2 Tides</div>
          <ul class="tide-list" id="cb-last"></ul>
          <div class="tide-subtitle" style="margin-top:10px;">Next 2 Tides</div>
          <ul class="tide-list" id="cb-next"></ul>
        </div>

        <div class="updated" id="cb-updated">Updated: —</div>
      </section>
    </div>
  </div>

  <script>
    // ------- Utilities -------
    const getJSON = async (url) => {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    };
    const toFixed = (n, d = 1) => (n == null || !isFinite(n) ? "N/A" : Number(n).toFixed(d));
    const ktsToMph = (k) => (k == null || !isFinite(k) ? null : k * 1.15078);
    const degToCardinal = (deg) => {
      if (deg == null || !isFinite(deg)) return "N/A";
      const a = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      return a[Math.round(deg / 22.5) % 16];
    };
    const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };

    let airCache = null;
    async function loadAirKORF(){
      if (airCache) return airCache;
      try{
        const a = await getJSON(`https://api.weather.gov/stations/KORF/observations/latest`);
        const c = a?.properties?.temperature?.value;
        const t = a?.properties?.timestamp;
        airCache = c!=null ? { f:(c*9/5+32), t: new Date(t) } : null;
      }catch{ airCache = null; }
      return airCache;
    }

    async function loadWater(station){
      try{
        const j = await getJSON(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=water_temperature&station=${station}&time_zone=lst_ldt&units=english&format=json&date=latest`);
        const d = j?.data?.[0];
        return d ? { f: parseFloat(d.v), t: new Date(d.t) } : null;
      }catch{ return null; }
    }

    async function loadWind(station){
      try{
        const j = await getJSON(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=wind&station=${station}&time_zone=lst_ldt&units=english&format=json&date=latest`);
        const d = j?.data?.[0];
        if (!d) return null;
        return { mph: ktsToMph(parseFloat(d.s)), dir: parseFloat(d.d), t: new Date(d.t) };
      }catch{ return null; }
    }

    async function loadTides(station){
      try{
        const now = new Date();
        const begin = new Date(now.getTime() - 24*60*60*1000);
        const y = begin.getFullYear(), m = String(begin.getMonth()+1).padStart(2,'0'), d = String(begin.getDate()).padStart(2,'0');
        const j = await getJSON(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=predictions&station=${station}&datum=MLLW&time_zone=lst_ldt&units=english&interval=hilo&format=json&begin_date=${y}${m}${d}&range=72`);
        const preds = j?.predictions || [];
        const nowMs = now.getTime();
        const last2 = preds.filter(p => new Date(p.t).getTime() < nowMs).slice(-2);
        const next2 = preds.filter(p => new Date(p.t).getTime() >= nowMs).slice(0,2);
        return { last2, next2 };
      }catch{ return { last2:[], next2:[] }; }
    }

    function renderTideList(elId, list){
      const el = document.getElementById(elId);
      if (!el) return;
      if (!list.length){ el.innerHTML = '<li><div class="tide-row"><span class="tide-type">—</span><span class="tide-val">No data</span></div><div class="tide-time"></div></li>'; return; }
      el.innerHTML = list.map(p => {
        const when = new Date(p.t);
        const type = p.type === 'H' ? 'High' : 'Low';
        return `<li>
          <div class="tide-row">
            <span class="tide-type">${type} Tide</span>
            <span class="tide-val">${toFixed(parseFloat(p.v))} ft</span>
          </div>
          <div class="tide-time">${when.toLocaleString()}</div>
        </li>`;
      }).join('');
    }

    function stampUpdated(elId, dates){
      const el = document.getElementById(elId);
      if (!el) return;
      if (!dates.length){ el.textContent = 'Updated: —'; return; }
      const latest = new Date(Math.max(...dates.map(d => d.getTime())));
      el.textContent = 'Updated: ' + latest.toLocaleString();
    }

    async function fillStation(cfg){
      const stamps = [];

      const [water, wind, tides, air] = await Promise.all([
        loadWater(cfg.coops),
        loadWind(cfg.coops),
        loadTides(cfg.coops),
        loadAirKORF()
      ]);

      setText(cfg.ids.water, water ? `${toFixed(water.f)} °F` : 'No data');
      if (water?.t) stamps.push(water.t);

      setText(cfg.ids.air, air ? `${toFixed(air.f)} °F` : 'No data');
      if (air?.t) stamps.push(air.t);

      const windStr = wind ? `${toFixed(wind.mph)} mph (${degToCardinal(wind.dir)})` : 'No data';
      setText(cfg.ids.wind, windStr);
      if (wind?.t) stamps.push(wind.t);

      renderTideList(cfg.ids.last, tides.last2);
      renderTideList(cfg.ids.next, tides.next2);

      stampUpdated(cfg.ids.updated, stamps);
    }

    async function loadAll(){
      document.getElementById('notice').textContent = '';
      await Promise.allSettled([
        fillStation({ coops:'8639348', ids: { water:'mo-water', air:'mo-air', wind:'mo-wind', last:'mo-last', next:'mo-next', updated:'mo-updated' }}), // Money
        fillStation({ coops:'8638610', ids: { water:'se-water', air:'se-air', wind:'se-wind', last:'se-last', next:'se-next', updated:'se-updated' }}), // Sewells        
        fillStation({ coops:'8638999', ids: { water:'ca-water', air:'ca-air', wind:'ca-wind', last:'ca-last', next:'ca-next', updated:'ca-updated' }}), // Cape Henry
        fillStation({ coops:'8638901', ids: { water:'cb-water', air:'cb-air', wind:'cb-wind', last:'cb-last', next:'cb-next', updated:'cb-updated' }})  // CBBT
      ]);
    }

    document.getElementById('refreshBtn').addEventListener('click', e => { e.preventDefault(); loadAll(); });
    loadAll();
  </script>
</body>
</html>
