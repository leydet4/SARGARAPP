<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Todd Dooley SAR Forum 2026</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="SAR.png">
<link rel="apple-touch-icon" href="SAR.png">
<meta name="theme-color" content="#0f172a">

<script src="https://cdn.tailwindcss.com"></script>

<style>
body { font-family: system-ui, sans-serif; }

.card {
  background:#1e293b;
  border-radius:18px;
  padding:22px;
  box-shadow:0 0 25px rgba(0,0,0,.35);
}

.section-title {
  font-size:15px;
  font-weight:700;
  letter-spacing:.5px;
}

.source {
  color:#94a3b8;
  font-size:12px;
  margin-top:6px;
}

.primary-value {
  font-size:26px;
  font-weight:900;
  margin-top:10px;
}

.secondary-value {
  font-size:14px;
  color:#cbd5e1;
  margin-top:4px;
}

.tide-trend {
  font-size:34px;
  font-weight:900;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  margin-top:16px;
}

.tide-arrow { font-size:50px; }
.rising { color:#22c55e; }
.falling { color:#38bdf8; }

.countdown {
  font-size:20px;
  font-weight:900;
  margin-top:10px;
  color:#facc15;
}

.tide-list {
  font-size:17px;
  font-weight:700;
  line-height:1.7;
}

.big-btn {
  padding:10px 18px;
  border-radius:12px;
  font-weight:800;
  transition:.2s;
  font-size:14px;
}

.big-btn:hover { transform:scale(1.05); }

.subtitle {
  font-size:13px;
  color:#94a3b8;
}

.install-banner {
  background:#111827;
  padding:16px;
  text-align:center;
  font-size:13px;
  color:#cbd5e1;
  border-top:1px solid #1f2937;
  border-bottom:1px solid #1f2937;
}

.refresh-status {
  font-size:13px;
  margin-top:6px;
  color:#94a3b8;
}
</style>
</head>

<body class="bg-slate-900 text-white">

<header class="bg-slate-800 py-6 text-center shadow-lg">

<img src="SAR.png" class="mx-auto h-20 mb-3">

<h1 class="text-2xl font-black">
Todd Dooley SAR Forum 2026
</h1>

<div class="subtitle mt-1">
HRBT Marine Operations Dashboard (All Times Eastern)
</div>

<div class="flex justify-center gap-3 mt-6 flex-wrap">

<a href="gar.html" class="big-btn bg-blue-600 hover:bg-blue-700">Submit GAR</a>

<a href="sar-resources.html" class="big-btn bg-emerald-600 hover:bg-emerald-700">Resources</a>

<a href="admin.html" class="big-btn bg-red-700 hover:bg-red-800">Admin</a>

<button id="installBtn"
class="big-btn bg-indigo-600 hover:bg-indigo-700 hidden">
Install App
</button>

<a href="povsargarapp-qr.png" target="_blank"
class="big-btn bg-purple-600 hover:bg-purple-700">
Install QR
</a>

<button id="refreshBtn"
class="big-btn bg-orange-500 hover:bg-orange-600">
Refresh Data
</button>

</div>

<div id="refreshStatus" class="refresh-status"></div>

</header>

<section id="installBanner" class="install-banner hidden">
<strong>Install This App</strong><br>
üì± Android: Tap <strong>Install App</strong> or use browser menu.<br>
üçé iPhone: Open in Safari ‚Üí Share ‚Üí Add to Home Screen.
</section>

<section class="p-5 md:p-8 space-y-8">

<div class="text-center text-sm text-slate-400">
Last Updated (Eastern): <span id="lastUpdated">--</span>
</div>

<div class="grid md:grid-cols-4 gap-6">

<div class="card text-center">
<div class="section-title">WIND (Near HRBT)</div>
<div id="windText" class="primary-value">--</div>
<div id="windCardinal" class="secondary-value"></div>
<div id="windGust" class="secondary-value"></div>
<div id="windSource" class="source">--</div>
</div>

<div class="card text-center">
<div class="section-title">WAVE HEIGHT</div>
<div id="waveHeight" class="primary-value">--</div>
<div id="waveSource" class="source">--</div>
</div>

<div class="card text-center">
<div class="section-title">WATER TEMP</div>
<div id="waterTemp" class="primary-value">--</div>
<div id="waterSource" class="source">--</div>
</div>

<div class="card text-center">
<div class="section-title">AIR TEMP</div>
<div id="airTemp" class="primary-value">--</div>
<div id="airSource" class="source">--</div>
</div>

</div>

<div class="card text-center">

<div class="section-title">
TIDES ‚Äî Sewells Point (Near HRBT)
</div>

<div id="tideTrend" class="tide-trend"></div>
<div id="tideCountdown" class="countdown"></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">

<div>
<div class="font-semibold mb-2 text-lg">Last 2</div>
<div id="lastTides" class="tide-list"></div>
</div>

<div>
<div class="font-semibold mb-2 text-lg">Next 2</div>
<div id="nextTides" class="tide-list"></div>
</div>

</div>

<div id="tideSource" class="source mt-6"></div>

</div>

</section>

<script>

// INSTALL AUTO-HIDE
let deferredPrompt;
const installBtn = document.getElementById('installBtn');
const installBanner = document.getElementById('installBanner');

function isStandalone() {
  return window.matchMedia('(display-mode: standalone)').matches ||
         window.navigator.standalone === true;
}

if (!isStandalone()) {
  installBanner.classList.remove('hidden');
}

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.remove('hidden');
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  installBtn.classList.add('hidden');
  installBanner.classList.add('hidden');
  deferredPrompt = null;
});

// REFRESH LOGIC
const refreshBtn = document.getElementById('refreshBtn');
const refreshStatus = document.getElementById('refreshStatus');

refreshBtn.addEventListener('click', async () => {
  refreshBtn.disabled = true;
  refreshBtn.innerText = "Refreshing...";
  refreshStatus.innerText = "";

  await loadMarineData();

  refreshBtn.disabled = false;
  refreshBtn.innerText = "Refresh Data";
  refreshStatus.innerText = "Updated ‚úì";

  setTimeout(() => {
    refreshStatus.innerText = "";
  }, 3000);
});

// MARINE DATA FUNCTIONS

function degToCardinal(deg) {
  if (deg === null || deg === undefined) return "--";
  const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return dirs[Math.round(deg / 22.5) % 16];
}

function parseEastern(str) {
  const [date, time] = str.split(" ");
  return new Date(date + "T" + time);
}

function formatTide(dateObj, type, height) {
  const label = type === "H" ? "High" : "Low";
  const time = dateObj.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
  return `${label} ‚Äî ${time} ‚Äî ${height} ft`;
}

let nextTideTime = null;
let nextTideType = null;

function updateCountdown() {
  if (!nextTideTime) return;
  const now = new Date();
  const diff = nextTideTime - now;
  if (diff <= 0) {
    document.getElementById("tideCountdown").innerText =
      "Tide change occurring now";
    return;
  }
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  document.getElementById("tideCountdown").innerText =
    `${h}h ${m}m until ${nextTideType} tide`;
}

async function loadMarineData() {
  const res = await fetch("/.netlify/functions/marine");
  const data = await res.json();

  document.getElementById("lastUpdated").innerText = data.serverTimeEST;

  const wind = data.windData;
  document.getElementById("windText").innerText =
    wind.windSpeedKnots + " kts";
  document.getElementById("windCardinal").innerText =
    degToCardinal(wind.windDirDeg) + " (" + wind.windDirDeg + "¬∞)";
  document.getElementById("windGust").innerText =
    wind.windGustKnots ? "Gusts: " + wind.windGustKnots + " kts" : "";
  document.getElementById("windSource").innerText =
    "Wind observations from " + wind.stationName;

  const buoy = data.buoyData;
  document.getElementById("waveHeight").innerText =
    buoy.waveHeightFt + " ft @ " + buoy.dominantPeriodSec + "s";
  document.getElementById("waveSource").innerText =
    "Wave data from " + buoy.stationName;
  document.getElementById("waterTemp").innerText =
    buoy.waterTempF + " ¬∞F";
  document.getElementById("waterSource").innerText =
    "Water temperature from " + buoy.stationName;
  document.getElementById("airTemp").innerText =
    buoy.airTempF ? buoy.airTempF + " ¬∞F" : "--";
  document.getElementById("airSource").innerText =
    "Air temperature from NOAA sensors near HRBT";

  const serverNow = new Date(data.serverTimeEST);
  const tides = data.tideData.predictions.map(t => ({
    ...t,
    parsed: parseEastern(t.t)
  })).sort((a,b) => a.parsed - b.parsed);

  const past = tides.filter(t => t.parsed <= serverNow);
  const future = tides.filter(t => t.parsed > serverNow);

  const lastTwo = past.slice(-2);
  const nextTwo = future.slice(0,2);

  document.getElementById("lastTides").innerHTML =
    lastTwo.length ? lastTwo.map(t => formatTide(t.parsed, t.type, t.v)).join("<br>") : "--";

  document.getElementById("nextTides").innerHTML =
    nextTwo.length ? nextTwo.map(t => formatTide(t.parsed, t.type, t.v)).join("<br>") : "--";

  if (nextTwo.length > 0) {
    nextTideTime = nextTwo[0].parsed;
    nextTideType = nextTwo[0].type === "H" ? "High" : "Low";
    document.getElementById("tideTrend").innerHTML =
      nextTwo[0].type === "H"
        ? `<span class="rising tide-arrow">‚Üë</span> Rising`
        : `<span class="falling tide-arrow">‚Üì</span> Falling`;
    updateCountdown();
  }

  document.getElementById("tideSource").innerText =
    "Tide predictions from " + data.tideStationName;
}

loadMarineData();
setInterval(updateCountdown, 30000);

</script>

</body>
</html>
