<script>

let tideChart;

async function loadMarineData() {

try {

const response = await fetch("/.netlify/functions/marine");
if (!response.ok) throw new Error("Function returned " + response.status);

const data = await response.json();
console.log("Marine Data:", data);

// ===== WATER LEVEL =====
if (data.levelData && data.levelData.data && data.levelData.data.length > 0) {
document.getElementById("waterLevel").innerText =
data.levelData.data[0].v + " ft";
}

// ===== NEXT TIDE =====
if (data.tideData && data.tideData.predictions) {
const predictions = data.tideData.predictions;
const now = new Date();
const next = predictions.find(p => new Date(p.t) > now);

if (next) {
document.getElementById("nextTide").innerText =
(next.type === "H" ? "High" : "Low") + " at " + next.t;
}
}

// ===== WEATHER =====
if (data.weatherData && data.weatherData.properties) {
const w = data.weatherData.properties;

const windSpeed = w.windSpeed?.value
? (w.windSpeed.value * 2.237).toFixed(1)
: "N/A";

const windDir = w.windDirection?.value || 0;

document.getElementById("windText").innerText =
windSpeed + " mph " + windDir + "Â°";

document.getElementById("windArrow").style.transform =
`translateX(-50%) rotate(${windDir}deg)`;
}

// ===== TIDE CHART =====
if (data.tideData && data.tideData.predictions) {

const labels = data.tideData.predictions.map(p => p.t.substring(11,16));
const values = data.tideData.predictions.map((_, i) => i);

if (tideChart) tideChart.destroy();

tideChart = new Chart(document.getElementById("tideChart"), {
type: "line",
data: {
labels: labels,
datasets: [{
label: "Tide Cycle",
data: values,
borderColor: "#f97316",
backgroundColor: "rgba(249,115,22,0.2)",
fill: true,
tension: 0.4
}]
},
options: {
plugins: { legend: { labels:{ color:"white"} } },
scales: {
x: { ticks:{ color:"white"} },
y: { ticks:{ color:"white"} }
}
}
});
}

document.getElementById("statusMessage").innerText = "Marine Data Connected";
document.getElementById("statusMessage").classList.remove("text-yellow-400");
document.getElementById("statusMessage").classList.add("text-green-400");

} catch (error) {

console.error("Marine Load Error:", error);

document.getElementById("statusMessage").innerText =
"Marine Data Failed: " + error.message;

document.getElementById("statusMessage").classList.remove("text-yellow-400");
document.getElementById("statusMessage").classList.add("text-red-500");

}

}

loadMarineData();
setInterval(loadMarineData, 300000);

</script>
