<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>POV SAR Forum 2026</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="icon" href="SAR.png">
<link rel="apple-touch-icon" href="SAR.png">

<script src="https://cdn.tailwindcss.com"></script>

<style>
body { font-family: system-ui, sans-serif; }

.card {
  background:#1e293b;
  border-radius:16px;
  padding:18px;
  box-shadow:0 0 25px rgba(0,0,0,.35);
}

.section-title { font-size:16px; font-weight:700; }
.source { color:#64748b; font-size:11px; margin-top:3px; }
.primary-value { font-size:22px; font-weight:900; margin-top:6px; }
.secondary-value { font-size:15px; color:#94a3b8; }

.tide-trend {
  font-size:32px;
  font-weight:900;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
  margin-top:12px;
}

.tide-arrow { font-size:52px; }
.rising { color:#22c55e; }
.falling { color:#38bdf8; }

.countdown {
  font-size:24px;
  font-weight:900;
  margin-top:10px;
  color:#facc15;
}

.tide-list {
  font-size:18px;
  font-weight:700;
  line-height:1.6;
}

.big-btn {
  padding:12px 20px;
  border-radius:12px;
  font-weight:800;
  transition:.2s;
}

.big-btn:hover { transform:scale(1.05); }
.subtitle { font-size:13px; color:#94a3b8; }
</style>
</head>

<body class="bg-slate-900 text-white">

<header class="bg-slate-800 py-6 shadow-lg text-center">

<img src="SAR.png" class="mx-auto h-20 mb-3">

<h1 class="text-2xl font-black tracking-wide">
Port of Virginia Todd Dooley<br>
Search and Rescue Forum 2026
</h1>

<div class="subtitle mt-1">
HRBT Marine Operations Dashboard (All Times Eastern)
</div>

<div class="flex justify-center gap-3 mt-5 flex-wrap">

<a href="gar.html" class="big-btn bg-blue-600 hover:bg-blue-700">GAR</a>
<a href="admin.html" class="big-btn bg-red-700 hover:bg-red-800">ADMIN</a>
<a href="resources.html" class="big-btn bg-slate-600 hover:bg-slate-700">RESOURCES</a>

<button id="installBtn"
class="big-btn bg-green-600 hover:bg-green-700 hidden">
INSTALL
</button>

<button onclick="loadMarineData()"
class="big-btn bg-orange-500 hover:bg-orange-600">
REFRESH
</button>

</div>

</header>

<section class="p-4 md:p-6 space-y-6">

<div class="text-center text-sm text-slate-400">
Last Updated (Eastern): <span id="lastUpdated">--</span>
</div>

<div class="grid md:grid-cols-4 gap-5">

<div class="card text-center">
<div class="section-title">WIND</div>
<div id="windSource" class="source">Loading...</div>
<div id="windText" class="primary-value">--</div>
<div id="windCardinal" class="secondary-value"></div>
</div>

<div class="card text-center">
<div class="section-title">WAVE HEIGHT</div>
<div class="source">NOAA Buoy 44099 — Chesapeake Bay Entrance</div>
<div id="waveHeight" class="primary-value">--</div>
</div>

<div class="card text-center">
<div class="section-title">WATER TEMP</div>
<div class="source">NOAA Buoy 44099 — Chesapeake Bay Entrance</div>
<div id="waterTemp" class="primary-value">--</div>
</div>

<div class="card text-center">
<div class="section-title">AIR TEMP</div>
<div class="source">NOAA Weather Station KORF</div>
<div id="airTemp" class="primary-value">--</div>
</div>

</div>

<div class="card text-center">

<div class="section-title">
TIDES — Sewells Point (Near HRBT)
</div>

<div id="tideTrend" class="tide-trend"></div>
<div id="tideCountdown" class="countdown"></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">

<div>
<div class="font-semibold mb-2 text-lg">Last 2</div>
<div id="lastTides" class="tide-list"></div>
</div>

<div>
<div class="font-semibold mb-2 text-lg">Next 2</div>
<div id="nextTides" class="tide-list"></div>
</div>

</div>

</div>

<div class="text-center text-xs text-slate-500">
Buoy Observation (Eastern): <span id="buoyTime">--</span>
</div>

</section>

<script>

// FIXED TIME PARSER (NO FORCED OFFSET)
function parseEastern(str) {
  const [date, time] = str.split(" ");
  return new Date(date + "T" + time);
}

function formatTideDisplay(dateObj) {
  return dateObj.toLocaleDateString([], {
    month: "short",
    day: "numeric"
  }) + " — " +
  dateObj.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });
}

let nextTideTime = null;
let nextTideType = null;

function updateCountdown() {
  if (!nextTideTime) return;

  const now = new Date();
  const diff = nextTideTime - now;

  if (diff <= 0) {
    document.getElementById("tideCountdown").innerText =
      "Tide change occurring now";
    return;
  }

  const hours = Math.floor(diff / 3600000);
  const minutes = Math.floor((diff % 3600000) / 60000);

  document.getElementById("tideCountdown").innerText =
    `${hours}h ${minutes}m until ${nextTideType} tide (${formatTideDisplay(nextTideTime)})`;
}

async function loadMarineData() {

  const response = await fetch("/.netlify/functions/marine");
  const data = await response.json();

  document.getElementById("lastUpdated").innerText = data.serverTimeEST;

  const tides = data.tideData.predictions.map(t => ({
    ...t,
    parsed: parseEastern(t.t)
  }));

  const now = new Date();

  const past = tides.filter(t => t.parsed <= now);
  const future = tides.filter(t => t.parsed > now);

  const lastTwo = past.slice(-2);
  const nextTwo = future.slice(0,2);

  document.getElementById("lastTides").innerHTML =
    lastTwo.length
      ? lastTwo.map(t =>
          `${t.type === "H" ? "High" : "Low"} — ${formatTideDisplay(t.parsed)}`
        ).join("<br>")
      : "No previous tides yet";

  document.getElementById("nextTides").innerHTML =
    nextTwo.length
      ? nextTwo.map(t =>
          `${t.type === "H" ? "High" : "Low"} — ${formatTideDisplay(t.parsed)}`
        ).join("<br>")
      : "No upcoming tides";

  if (nextTwo.length > 0) {
    nextTideTime = nextTwo[0].parsed;
    nextTideType = nextTwo[0].type === "H" ? "High" : "Low";

    document.getElementById("tideTrend").innerHTML =
      nextTwo[0].type === "H"
      ? `<span class="rising tide-arrow">↑</span> Rising`
      : `<span class="falling tide-arrow">↓</span> Falling`;

    updateCountdown();
  }
}

loadMarineData();
setInterval(loadMarineData, 300000);
setInterval(updateCountdown, 30000);

</script>

</body>
</html>