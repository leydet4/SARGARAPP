<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>POV SAR Forum 2026</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="icon" href="povsargarapp-qr.png">

<script src="https://cdn.tailwindcss.com"></script>

<style>
body { font-family: system-ui, sans-serif; }
.card { background:#1e293b; border-radius:12px; padding:14px; }
.section-title { font-size:14px; font-weight:700; }
.source { color:#64748b; font-size:11px; margin-top:2px; }
.primary-value { font-size:20px; font-weight:800; margin-top:4px; }
.secondary-value { font-size:13px; color:#94a3b8; }
.tide-trend { font-size:28px; font-weight:900; display:flex; align-items:center; gap:10px; margin-top:8px; }
.tide-arrow { font-size:36px; }
.rising { color:#22c55e; }
.falling { color:#38bdf8; }
.countdown { font-size:18px; font-weight:700; margin-top:6px; color:#facc15; }
.install-box { background:#0f172a; border:1px solid #334155; border-radius:10px; padding:12px; font-size:13px; }
</style>
</head>

<body class="bg-slate-900 text-white">

<header class="bg-slate-800 px-4 py-3 flex justify-between items-center">
<h1 class="text-lg font-bold">POV SAR Forum 2026 (All Times Eastern)</h1>
<div class="flex gap-2">
<a href="gar.html" class="bg-blue-600 px-3 py-1 rounded text-sm font-semibold">GAR</a>
<button onclick="loadMarineData()" class="bg-orange-500 px-3 py-1 rounded text-sm font-semibold">Refresh</button>
</div>
</header>

<section class="p-4 space-y-4">

<div class="text-xs text-slate-400">
Last Updated (Eastern): <span id="lastUpdated">--</span>
</div>

<div class="grid md:grid-cols-4 gap-4">

<div class="card text-center">
<div class="section-title">Wind</div>
<div id="windSource" class="source">Loading...</div>
<div id="windText" class="primary-value">--</div>
<div id="windCardinal" class="secondary-value"></div>
</div>

<div class="card text-center">
<div class="section-title">Wave Height</div>
<div class="source">NOAA Buoy 44099 — Chesapeake Bay Entrance (Near HRBT)</div>
<div id="waveHeight" class="primary-value">--</div>
</div>

<div class="card text-center">
<div class="section-title">Water Temperature</div>
<div class="source">NOAA Buoy 44099 — Chesapeake Bay Entrance (Near HRBT)</div>
<div id="waterTemp" class="primary-value">--</div>
</div>

<div class="card text-center">
<div class="section-title">Air Temperature</div>
<div class="source">NOAA Weather Station KORF — Norfolk International Airport</div>
<div id="airTemp" class="primary-value">--</div>
</div>

</div>

<div class="card">
<div class="section-title">Tides</div>
<div class="source">NOAA CO-OPS Sewells Point — Near HRBT</div>

<div id="tideTrend" class="tide-trend"></div>
<div id="tideCountdown" class="countdown"></div>

<div class="grid md:grid-cols-2 gap-6 mt-3">
<div>
<div class="text-sm font-semibold mb-1">Last</div>
<div id="lastTides" class="text-sm"></div>
</div>
<div>
<div class="text-sm font-semibold mb-1">Next</div>
<div id="nextTides" class="text-sm"></div>
</div>
</div>
</div>

<div class="text-xs text-slate-500">
Buoy Observation (Eastern): <span id="buoyTime">--</span>
</div>

</section>

<script>

function parseEastern(str) {
  const [date, time] = str.split(" ");
  const [y,m,d] = date.split("-");
  const [hh,mm] = time.split(":");
  return new Date(`${y}-${m}-${d}T${hh}:${mm}:00-05:00`);
}

function degreesToCardinal(deg) {
  if (!deg || deg === "N/A" || isNaN(deg)) return "";
  const dirs = ["N","NE","E","SE","S","SW","W","NW"];
  return dirs[Math.round(deg / 45) % 8];
}

let nextTideTime = null;
let nextTideType = null;

function updateCountdown() {
  if (!nextTideTime) return;
  const now = new Date();
  const diff = nextTideTime - now;
  if (diff <= 0) {
    document.getElementById("tideCountdown").innerText = "Tide change occurring now";
    return;
  }
  const hours = Math.floor(diff / 3600000);
  const minutes = Math.floor((diff % 3600000) / 60000);
  document.getElementById("tideCountdown").innerText =
    `${hours}h ${minutes}m until ${nextTideType} tide (${nextTideTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})})`;
}

async function loadMarineData() {

  const response = await fetch("/.netlify/functions/marine");
  const data = await response.json();

  document.getElementById("lastUpdated").innerText = data.serverTimeEST;

  const b = data.buoyData;

  document.getElementById("windText").innerText =
    b.windSpeedKnots !== "N/A" ? b.windSpeedKnots + " kts" : "N/A";

  document.getElementById("windCardinal").innerText =
    degreesToCardinal(parseInt(b.windDirDeg)) +
    (b.windDirDeg !== "N/A" ? ` (${b.windDirDeg}°)` : "");

  document.getElementById("windSource").innerText = b.windSource;
  document.getElementById("waveHeight").innerText = `${b.waveHeightFt} ft @ ${b.dominantPeriodSec}s`;
  document.getElementById("waterTemp").innerText = `${b.waterTempF} °F`;
  document.getElementById("airTemp").innerText = `${b.airTempF} °F`;
  document.getElementById("buoyTime").innerText = b.buoyObservationTimeEST;

  const tides = data.tideData.predictions.map(t => ({
    ...t,
    parsed: parseEastern(t.t)
  }));

  const now = new Date();

  const lastTwo = tides.filter(t => t.parsed < now).slice(-2);
  const nextTwo = tides.filter(t => t.parsed > now).slice(0,2);

  document.getElementById("lastTides").innerHTML =
    lastTwo.map(t =>
      `${t.type === "H" ? "High" : "Low"} - ${t.parsed.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`
    ).join("<br>");

  document.getElementById("nextTides").innerHTML =
    nextTwo.map(t =>
      `${t.type === "H" ? "High" : "Low"} - ${t.parsed.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`
    ).join("<br>");

  if (nextTwo.length > 0) {
    nextTideTime = nextTwo[0].parsed;
    nextTideType = nextTwo[0].type === "H" ? "High" : "Low";

    document.getElementById("tideTrend").innerHTML =
      nextTwo[0].type === "H"
      ? `<span class="rising tide-arrow">↑</span> Rising`
      : `<span class="falling tide-arrow">↓</span> Falling`;

    updateCountdown();
  }
}

loadMarineData();
setInterval(loadMarineData, 300000);
setInterval(updateCountdown, 30000);

</script>

</body>
</html>
