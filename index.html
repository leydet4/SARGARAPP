<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>POV SAR Forum 2026 - Ops Dashboard</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0f172a" />
<link rel="icon" href="povsargarapp-qr.png">

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { font-family: system-ui, sans-serif; }
.card { background:#1e293b; border-radius:12px; padding:20px; }
.label { color:#94a3b8; font-size:13px; }
.value { font-size:18px; font-weight:600; }
#map { height: 350px; border-radius:12px; }

.compass {
width:120px;
height:120px;
border:3px solid #64748b;
border-radius:50%;
position:relative;
margin:auto;
}
.arrow {
width:4px;
height:50px;
background:#f97316;
position:absolute;
top:15px;
left:50%;
transform-origin:bottom;
}
</style>
</head>

<body class="bg-slate-900 text-white">

<header class="bg-slate-800 p-4">
<h1 class="font-bold text-lg">POV SAR Forum 2026 - Ops Dashboard</h1>
</header>

<section class="p-6 space-y-6">

<div id="statusMessage" class="text-yellow-400 font-semibold">
Connecting to Marine Data...
</div>

<div class="grid md:grid-cols-3 gap-6">

<!-- Wind -->
<div class="card text-center">
<div class="label">Wind</div>
<div class="compass mt-4">
<div id="windArrow" class="arrow"></div>
</div>
<div id="windText" class="value mt-4">Loading...</div>
</div>

<!-- Waves -->
<div class="card">
<div class="label">Wave Height</div>
<div id="waveHeight" class="value">Loading...</div>
</div>

<!-- Water Temp -->
<div class="card">
<div class="label">Water Temperature</div>
<div id="waterTemp" class="value">Loading...</div>
</div>

</div>

<!-- Tide Section -->
<div class="card">
<div class="label mb-2">Tide Trend</div>
<div id="tideTrend" class="value mb-4">Loading...</div>

<div class="grid md:grid-cols-2 gap-6">

<div>
<div class="label">Last 2 Tides</div>
<div id="lastTides" class="value text-sm mt-2"></div>
</div>

<div>
<div class="label">Next 2 Tides</div>
<div id="nextTides" class="value text-sm mt-2"></div>
</div>

</div>
</div>

<div class="card">
<div class="label mb-4">HRBT Operational Map</div>
<div id="map"></div>
</div>

</section>

<script>

async function loadMarineData() {

try {

const response = await fetch("/.netlify/functions/marine");
if (!response.ok) throw new Error("Function returned " + response.status);

const data = await response.json();
console.log(data);

// ===== BUOY =====
if (data.buoyData?.data?.length > 0) {

const b = data.buoyData.data[0];

document.getElementById("waveHeight").innerText =
b.wave_height + " ft @ " + b.dominant_wave_period + "s";

document.getElementById("waterTemp").innerText =
b.water_temperature + " °F";

document.getElementById("windText").innerText =
b.wind_speed + " kts " + b.wind_direction + "°";

document.getElementById("windArrow").style.transform =
`translateX(-50%) rotate(${b.wind_direction}deg)`;

}

// ===== TIDES =====
if (data.tideData?.predictions?.length > 0) {

const tides = data.tideData.predictions;
const now = new Date();

const lastTwo = tides.filter(t => new Date(t.t) < now).slice(-2);
const nextTwo = tides.filter(t => new Date(t.t) > now).slice(0,2);

document.getElementById("lastTides").innerHTML =
lastTwo.map(t => `${t.type === "H" ? "High" : "Low"} - ${t.t}`).join("<br>");

document.getElementById("nextTides").innerHTML =
nextTwo.map(t => `${t.type === "H" ? "High" : "Low"} - ${t.t}`).join("<br>");

if (nextTwo.length > 0) {
const rising = nextTwo[0].type === "H";
document.getElementById("tideTrend").innerText =
rising ? "Rising ↑" : "Falling ↓";
}

}

document.getElementById("statusMessage").innerText = "Marine Data Connected";
document.getElementById("statusMessage").classList.replace("text-yellow-400","text-green-400");

} catch (error) {

document.getElementById("statusMessage").innerText =
"Marine Data Failed";
document.getElementById("statusMessage").classList.replace("text-yellow-400","text-red-500");

console.error(error);

}

}

loadMarineData();
setInterval(loadMarineData, 300000);

// Map
const map = L.map('map').setView([36.98, -76.31], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([36.95, -76.33]).addTo(map).bindPopup("Sewells Point Tide Station");
L.marker([36.94, -75.72]).addTo(map).bindPopup("Buoy 44099");

</script>

</body>
</html>
